<!DOCTYPE html>
<html lang="hr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>COTISA - Chess Tournament System</title>
    
    <!-- MOBILE TOUCH FIX - New approach using JS touch handler -->
    <script src="js/mobile-touch-fix.js?v=1"></script>
    <style>
        /* Base mobile optimizations */
        * { -webkit-tap-highlight-color: transparent; }
        html, body { touch-action: pan-x pan-y; }
        
        /* Ensure overlays don't block */
        .modal-overlay:not(.active),
        .loading-overlay:not(.active) {
            display: none !important;
            pointer-events: none !important;
        }
        
        /* CRITICAL - Hide mobile nav items on desktop */
        @media (min-width: 577px) {
            .mobile-nav-item,
            .mobile-nav-divider {
                display: none !important;
            }
        }
        
        /* CRITICAL MOBILE STYLES - Inline for highest priority */
        @media (max-width: 576px) {
            body { font-size: 15px !important; }
            #app { padding-top: 56px !important; }
            .container { padding: 12px 16px !important; max-width: 100% !important; }
            
            /* Navigation */
            .navbar { padding: 8px 0 !important; }
            .nav-container { padding: 0 12px !important; }
            .nav-brand { font-size: 1rem !important; }
            .nav-brand .chess-icon { font-size: 1.2rem !important; }
            
            /* Hide nav menu (using dropdown instead) */
            .nav-menu { 
                display: none !important;
            }
            
            /* Cards */
            .card { 
                padding: 16px !important; 
                margin-bottom: 16px !important; 
                border-radius: 16px !important; 
            }
            .card-header h2 { font-size: 1.15rem !important; }
            
            /* Buttons */
            .btn { 
                padding: 14px 20px !important; 
                min-height: 52px !important; 
                font-size: 1rem !important;
                border-radius: 12px !important;
            }
            .btn-block { width: 100% !important; }
            
            /* Action buttons */
            .action-buttons { 
                flex-direction: column !important; 
                gap: 8px !important; 
            }
            .action-buttons .btn { width: 100% !important; }
            
            /* Tournament cards */
            .tournament-card { 
                padding: 16px !important; 
                border-radius: 16px !important; 
                margin-bottom: 12px !important;
            }
            .tournament-header { flex-direction: column !important; gap: 8px !important; }
            .tournament-actions { flex-direction: column !important; gap: 8px !important; }
            .tournament-actions .btn { width: 100% !important; }
            
            /* Forms */
            .form-control { 
                padding: 14px 16px !important; 
                font-size: 16px !important; 
                border-radius: 12px !important;
            }
            .form-group { margin-bottom: 16px !important; }
            
            /* Auth */
            .auth-card { padding: 24px 20px !important; border-radius: 16px !important; }
            .auth-header h1 { font-size: 1.5rem !important; }
            .auth-header .chess-icon { font-size: 3rem !important; }
            
            /* Stats grid */
            .stats-grid { 
                grid-template-columns: repeat(2, 1fr) !important; 
                gap: 8px !important; 
            }
            .stat-card { padding: 12px !important; }
            .stat-value { font-size: 1.5rem !important; }
            .stat-label { font-size: 0.7rem !important; }
            
            /* Profile */
            .profile-header { 
                flex-direction: column !important; 
                text-align: center !important; 
                padding: 20px 16px !important;
            }
            .profile-avatar { 
                width: 80px !important; 
                height: 80px !important; 
                margin: 0 auto 16px !important;
            }
            
            /* User dropdown - bottom sheet style */
            .user-dropdown {
                position: fixed !important;
                bottom: 0 !important;
                left: 0 !important;
                right: 0 !important;
                top: auto !important;
                max-width: 100% !important;
                border-radius: 20px 20px 0 0 !important;
                max-height: 70vh !important;
            }
            .user-dropdown-item { 
                padding: 16px !important; 
                min-height: 52px !important; 
            }
            
            /* Tables - hide on mobile, handled by JS */
            .table-responsive { overflow-x: auto !important; }
            table { font-size: 0.85rem !important; }
            th, td { padding: 8px !important; }
            .hide-mobile { display: none !important; }
            
            /* Flex between - stack on mobile */
            .flex-between {
                flex-direction: column !important;
                gap: 12px !important;
            }
            .flex-between .btn { width: 100% !important; }
            
            /* Create tournament form fixes */
            .main-settings, .advanced-settings { 
                padding: 0 !important;
            }
            #create-tournament-form .form-group { margin-bottom: 16px !important; }
            #create-tournament-form .btn { width: 100% !important; margin-bottom: 8px !important; }
            #create-tournament-form select.form-control { 
                padding: 14px 16px !important;
                font-size: 16px !important;
                appearance: none !important;
                -webkit-appearance: none !important;
                background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 4 5'%3e%3cpath fill='%23666' d='M2 0L0 2h4zm0 5L0 3h4z'/%3e%3c/svg%3e") !important;
                background-repeat: no-repeat !important;
                background-position: right 16px center !important;
                background-size: 8px 10px !important;
            }
            #create-tournament-form textarea.form-control {
                min-height: 100px !important;
                resize: vertical !important;
            }
            
            /* Modal fixes */
            .modal-content {
                position: fixed !important;
                bottom: 0 !important;
                left: 0 !important;
                right: 0 !important;
                top: auto !important;
                max-height: 90vh !important;
                border-radius: 20px 20px 0 0 !important;
                margin: 0 !important;
                width: 100% !important;
                max-width: 100% !important;
            }
            .modal-overlay {
                padding: 0 !important;
            }
            
            /* Notifications dropdown */
            .notifications-dropdown {
                position: fixed !important;
                bottom: 0 !important;
                left: 0 !important;
                right: 0 !important;
                top: auto !important;
                max-width: 100% !important;
                border-radius: 20px 20px 0 0 !important;
                max-height: 60vh !important;
            }
            
            /* Checkbox and label fixes */
            input[type="checkbox"] {
                width: 24px !important;
                height: 24px !important;
                min-width: 24px !important;
            }
            
            /* Meta items */
            .tournament-meta {
                display: flex !important;
                flex-direction: column !important;
                gap: 8px !important;
            }
            .meta-item {
                font-size: 0.9rem !important;
            }
        }
    </style>
    
    <link rel="stylesheet" href="css/themes.css?v=5">
    <link rel="stylesheet" href="css/main.css?v=17">
    <link rel="stylesheet" href="css/components.css?v=13">
    <link rel="stylesheet" href="css/game.css?v=7">
    <link rel="stylesheet" href="css/chess.css?v=9">
    <link rel="stylesheet" href="css/chess-customization.css?v=2">
    <link rel="stylesheet" href="css/theme-overrides.css?v=7">
    <link rel="stylesheet" href="css/button-fix.css?v=8">
    <link rel="stylesheet" href="css/mobile.css?v=23">
    <script>
        // Apply theme immediately to prevent flash
        (function() {
            const theme = localStorage.getItem('cotisa-theme') || 'light';
            document.documentElement.setAttribute('data-theme', theme);
        })();
    </script>
</head>
<body>
    <!-- Navigation Bar -->
    <nav id="navbar" class="navbar hidden">
        <div class="nav-container">
            <a href="#/dashboard" class="nav-brand">
                <img src="images/logo_cotisa.png" alt="COTISA" class="logo-icon">
            </a>
            <ul class="nav-menu" id="nav-menu">
                <li><a href="#/dashboard" id="nav-dashboard">üè† Poƒçetna</a></li>
                <li><a href="#/players" id="nav-players">üë• Igraƒçi</a></li>
                <li><a href="#/profile" id="nav-profile">üë§ Profil</a></li>
                <li><a href="#/admin" id="nav-admin" style="display: none;">‚öôÔ∏è Admin</a></li>
            </ul>
            <div class="user-info">
                <!-- Notifications -->
                <div class="notifications-container">
                    <button class="notification-bell" id="notification-bell">
                        üîî
                        <span class="notification-badge" id="notification-badge" style="display: none;">0</span>
                    </button>
                    <div class="notifications-dropdown" id="notifications-dropdown">
                        <div class="notifications-header">
                            <h3 data-i18n="notifications.title">Obavijesti</h3>
                            <button class="btn btn-sm btn-secondary" id="mark-all-read" style="font-size: 0.75rem; padding: 0.25rem 0.5rem;" data-i18n="notifications.markAll">
                                Oznaƒçi sve
                            </button>
                        </div>
                        <div class="notifications-list" id="notifications-list">
                            <div class="notification-empty">
                                <p data-i18n="notifications.empty">Nema novih obavijesti</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- User Dropdown Menu -->
                <div class="user-dropdown-container">
                    <button class="user-dropdown-btn" id="user-dropdown-btn" title="Korisniƒçki meni">
                        <span id="username-display">Korisnik</span>
                        <span id="user-role" class="role-badge"></span>
                        <span class="dropdown-arrow">‚ñº</span>
                    </button>
                    <div class="user-dropdown" id="user-dropdown">
                        <div class="user-dropdown-header">
                            <div class="user-avatar">üë§</div>
                            <div class="user-details">
                                <div class="user-name" id="dropdown-username">Korisnik</div>
                                <div class="user-email" id="dropdown-email">email@example.com</div>
                            </div>
                        </div>
                        <div class="user-dropdown-divider"></div>
                        <a href="#/profile" class="user-dropdown-item">
                            <span class="item-icon">üë§</span>
                            <span>Moj Profil</span>
                        </a>
                        <a href="#/admin" class="user-dropdown-item admin-only" style="display: none;" id="admin-dashboard-link">
                            <span class="item-icon">‚öôÔ∏è</span>
                            <span>Admin Upravljanje</span>
                        </a>
                        <a href="settings.html" class="user-dropdown-item">
                            <span class="item-icon">‚öôÔ∏è</span>
                            <span>Postavke</span>
                        </a>
                        <a href="help.html" class="user-dropdown-item">
                            <span class="item-icon">‚ùì</span>
                            <span>Pomoƒá</span>
                        </a>
                        <div class="user-dropdown-divider"></div>
                        <button class="user-dropdown-item logout-item" id="logout-btn">
                            <span class="item-icon">üö™</span>
                            <span>Odjava</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main App Container -->
    <div id="app"></div>

    <!-- Toast Container -->
    <div id="toast-container" class="toast-container"></div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay" style="display: none;">
        <div class="spinner-large"></div>
    </div>

    <!-- Theme System - Load first to prevent flash -->
    <script type="module" src="js/theme.js?v=4"></script>
    <script type="module" src="js/i18n.js?v=2"></script>
    <script type="module" src="js/userDropdown.js?v=5"></script>
    <script>
        // Apply board, piece styles and tabs position on load
        (function() {
            const boardStyle = localStorage.getItem('chess-board-style') || 'classic';
            const pieceStyle = localStorage.getItem('chess-piece-style') || 'classic';
            const tabsPosition = localStorage.getItem('tabs-position') || 'top';
            const compactMode = localStorage.getItem('compact-mode') === 'true';
            
            console.log('üè† INDEX.HTML - Uƒçitavanje stilova:');
            console.log('  üî≤ Board style:', boardStyle);
            console.log('  ‚ôüÔ∏è Piece style:', pieceStyle);
            console.log('  üìç Tabs position:', tabsPosition);
            console.log('  üì¶ Compact mode:', compactMode);
            
            document.body.setAttribute('data-board-style', boardStyle);
            document.body.setAttribute('data-piece-style', pieceStyle);
            document.body.setAttribute('data-tabs-position', tabsPosition);
            
            if (compactMode) {
                document.body.classList.add('compact-mode');
            }
        })();
        
        // Direct logout handler - this runs BEFORE module event handlers
        document.addEventListener('DOMContentLoaded', function() {
            const logoutBtn = document.getElementById('logout-btn');
            if (logoutBtn) {
                // Use onclick which has priority
                logoutBtn.onclick = function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('üö™ INDEX LOGOUT clicked - clearing session...');
                    
                    // Clear ALL authentication data
                    localStorage.removeItem('cotisa_user');
                    localStorage.removeItem('cotisa_session');
                    localStorage.removeItem('cotisa_auth_token');
                    localStorage.removeItem('access_token');
                    localStorage.removeItem('refresh_token');
                    
                    // Clear session storage too
                    sessionStorage.clear();
                    
                    console.log('‚úÖ Session cleared, redirecting to login...');
                    
                    // Force redirect using hash change
                    window.location.hash = '#/login';
                    window.location.reload();
                    return false;
                };
                console.log('‚úÖ Index logout handler attached');
            }
        });
    </script>
    
    <!-- Import modules - v30 forces cache refresh for spectator fix -->
    <script type="module" src="js/app_main.js?v=30"></script>
    <script type="module" src="js/router.js?v=30"></script>
    <script type="module" src="js/auth.js?v=30"></script>
    <script type="module" src="js/websocket.js?v=30"></script>
    <script type="module" src="js/api.js?v=30"></script>
    
    <!-- Import all views - ORDER MATTERS! Views with routes must load before dashboard -->
    <script type="module" src="js/views/tournamentDetailsNew.js?v=30"></script>
    <script type="module" src="js/views/gameView.js?v=30"></script>
    <script type="module" src="js/views/game.js?v=30"></script>
    <script type="module" src="js/views/spectatorView.js?v=31"></script>
    <script type="module" src="js/views/spectator.js?v=30"></script>
    <script type="module" src="js/views/createTournament.js?v=30"></script>
    <script type="module" src="js/views/joinTournament.js?v=30"></script>
    <script type="module" src="js/views/login.js?v=30"></script>
    <script type="module" src="js/views/forgotPassword.js?v=30"></script>
    <script type="module" src="js/views/resetPassword.js?v=30"></script>
    <script type="module" src="js/views/register.js?v=30"></script>
    <script type="module" src="js/views/profile.js?v=30"></script>
    <script type="module" src="js/views/players.js?v=30"></script>
    <script type="module" src="js/views/playerProfile.js?v=30"></script>
    <script type="module" src="js/views/admin.js?v=30"></script>
    <script type="module" src="js/views/dashboard.js?v=30"></script>
</body>
</html>
